{% extends 'base.html' %}

{% block meta %}
  <title>Login â€” Vintage Sports</title>
{% endblock meta %}

{% block content %}
<section class="max-w-md mx-auto">
  <h1 class="font-display text-2xl text-center">Masuk</h1>
  <p class="mt-1 text-neutral-600 text-center">Selamat datang kembali.</p>

  <div class="mt-6 card p-6">
    <form id="login-form" method="POST" action="" class="space-y-5">
      {% csrf_token %}

      {% if form.non_field_errors %}
        <ul class="errorlist">{{ form.non_field_errors }}</ul>
      {% endif %}

      <div class="space-y-1">
        <label for="{{ form.username.id_for_label }}">{{ form.username.label }}</label>
        {{ form.username }}
        {{ form.username.errors }}
      </div>

      <div class="space-y-1">
        <label for="{{ form.password.id_for_label }}">{{ form.password.label }}</label>
        {{ form.password }}
        {{ form.password.errors }}
      </div>

      <div>
        <input class="btn-primary w-full" type="submit" value="Login" />
      </div>
    </form>

    {% if messages %}
    <ul class="mt-4 text-sm text-red-600 space-y-1">
      {% for message in messages %}
      <li>{{ message }}</li>
      {% endfor %}
    </ul>
    {% endif %}

    <div class="mt-4 text-sm text-neutral-600 text-center">
      Belum punya akun?
      <a class="text-ink font-medium hover:text-gold" href="{% url 'main:register' %}">Daftar sekarang</a>
    </div>
  </div>
</section>

<script>
  (function(){
    const form = document.getElementById('login-form');
    if (!form) return;
    function getCSRFToken(){
      const name='csrftoken='; const parts=(document.cookie||'').split(';');
      for(let c of parts){ c=c.trim(); if(c.startsWith(name)) return decodeURIComponent(c.substring(name.length)); }
      return '';
    }
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const formData = new FormData(form);
      try{
        const res = await fetch("{% url 'main:login_ajax' %}", { method:'POST', headers:{ 'X-CSRFToken': getCSRFToken() }, body: formData });
        const data = await res.json();
        if (!res.ok || !data.success) {
          if (window.showToast) showToast('Gagal Login', 'Periksa kembali username atau password.', 'error');
          return;
        }
        try { sessionStorage.setItem('TOAST_FLASH', JSON.stringify({ title: 'Selamat datang', message: 'Login berhasil.', type: 'success', duration: 3000 })); } catch(e) {}
        window.location.href = data.redirect || "{% url 'main:show_main' %}";
      }catch(err){
        console.error(err);
        if (window.showToast) showToast('Error', 'Terjadi kesalahan saat login.', 'error');
      }
    });
  })();
</script>
{% endblock content %}
