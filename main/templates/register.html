{% extends 'base.html' %}

{% block meta %}
  <title>Register â€” Vintage Sports</title>
{% endblock meta %}

{% block content %}
<section class="max-w-md mx-auto">
  <h1 class="font-display text-2xl text-center">Buat Akun</h1>
  <p class="mt-1 text-neutral-600 text-center">Bergabung untuk mengelola koleksi vintage Anda.</p>

  <div class="mt-6 card p-6">
    <form id="register-form" method="POST" class="space-y-5">
      {% csrf_token %}

      {% if form.non_field_errors %}
        <ul class="errorlist">{{ form.non_field_errors }}</ul>
      {% endif %}

      <div class="space-y-1">
        <label for="{{ form.username.id_for_label }}">{{ form.username.label }}</label>
        {{ form.username }}
        {{ form.username.errors }}
      </div>

      <div class="space-y-1">
        <label for="{{ form.password1.id_for_label }}">{{ form.password1.label }}</label>
        {{ form.password1 }}
        {{ form.password1.errors }}
      </div>

      <div class="space-y-1">
        <label for="{{ form.password2.id_for_label }}">{{ form.password2.label }}</label>
        {{ form.password2 }}
        {{ form.password2.errors }}
      </div>

      <div>
        <input class="btn-primary w-full" type="submit" name="submit" value="Daftar" />
      </div>
    </form>

    {% if messages %}
    <ul class="mt-4 text-sm text-red-600 space-y-1">
      {% for message in messages %}
      <li>{{ message }}</li>
      {% endfor %}
    </ul>
    {% endif %}
  </div>
</section>

<script>
  (function(){
    const form = document.getElementById('register-form');
    if (!form) return;
    function getCSRFToken(){
      const name='csrftoken='; const parts=(document.cookie||'').split(';');
      for(let c of parts){ c=c.trim(); if(c.startsWith(name)) return decodeURIComponent(c.substring(name.length)); }
      return '';
    }
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const formData = new FormData(form);
      try{
        const res = await fetch("{% url 'main:register_ajax' %}", { method:'POST', headers:{ 'X-CSRFToken': getCSRFToken() }, body: formData });
        const data = await res.json();
        if (!res.ok || !data.success) {
          if (window.showToast) showToast('Gagal Daftar', 'Periksa kembali data yang dimasukkan.', 'error');
          return;
        }
        try { sessionStorage.setItem('TOAST_FLASH', JSON.stringify({ title: 'Berhasil', message: 'Akun berhasil dibuat. Silakan login.', type: 'success', duration: 3000 })); } catch(e) {}
        window.location.href = data.redirect || "{% url 'main:login' %}";
      }catch(err){
        console.error(err);
        if (window.showToast) showToast('Error', 'Terjadi kesalahan saat registrasi.', 'error');
      }
    });
  })();
</script>
{% endblock content %}
